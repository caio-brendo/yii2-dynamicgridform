class DynamicGridForm{config;insertButton;table;index;static bottom="bottom";static top="top";constructor(t){this.config=t,this.insertButton=$("#"+t.insertButton),this.table=$("#"+t.tableId),this.index=this.currentTotalRows,this.insertButton.on("click",this.handleClickInsertButton.bind(this)),this.deleteRowClass&&$(document).on("click",`#${this.widgetContainer} .${this.deleteRowClass}`,this.handleDeleteRow.bind(this)),$(document).on("click",this.selectorTableRows,this.handleClickRow.bind(this)),$("#"+this.config.widgetContainer).on("cancelEdit",this.cancelEdit.bind(this))}limitReached(){return 0!==this.config.max&&this.index+1>this.config.max}handleLimitReached(){this.triggerLimitReached()}get columns(){return this.config.columns}isInsertBottom(){return this.config.insertPosition===DynamicGridForm.bottom}async handleClickInsertButton(){if(this.isEditMode()){this.triggerBeforeUpdate();const t=await this.getHtmlRow(),e=this.rowEdit;e.after(t),e.remove(),this.reorderInputs(),this.triggerAfterUpdate(t)}else{if(this.limitReached())return void this.handleLimitReached();if(!1===await this.triggerBeforeInsertEvent())return;const t=await this.getHtmlRow();this.isInsertBottom()?this.tableBody.append(t):this.tableBody.prepend(t),this.triggerAfterInsertEvent(t),this.incrementIndex()}}async triggerBeforeInsertEvent(){const t=await this.getValueColumns(),e=this.getAllDataTable();return $("#"+this.config.widgetContainer).triggerHandler("beforeInsert",[t,e,this])}triggerAfterInsertEvent(t){$("#"+this.config.widgetContainer).triggerHandler("afterInsert",t)}triggerLimitReached(){$("#"+this.config.widgetContainer).triggerHandler("limitReached")}getTrHtml(t){return`<tr ${this.rowOptions}>${t}</tr>`}async handleDeleteRow(t){t.stopPropagation();const{currentTarget:e}=t,i=$(e).parent().parent();!1!==this.triggerBeforeDelete(i.get(0))&&(i.remove(),this.reorderInputs(),this.triggerAfterDelete(i))}incrementIndex(){this.index+=1}decrementIndex(){this.index-=1}get index(){return this.index}handleClickRow(t){const{currentTarget:e}=t;if(this.config.allowEdit){this.isEditMode()&&this.cancelEdit(),$(e).attr("data-edit",!0);let t=[];$(e).find("input[data-reference]").each(((e,i)=>{const r=$(i).attr("data-reference"),n=$("#"+r);-1===t.indexOf(r)&&InputHelper.elementIsDiv(n)&&n.find('input[type="checkbox"]').prop("checked",!1),-1===t.indexOf(r)&&InputHelper.inputIsSelectMultiple(n)&&n.val("");InputFactory.getInstance(n).setValue($(i).val()),t.push(r)}))}}async getValueColumns(){const t={};for(const[e,i]of this.columns.entries())if(i.id){const r=$("#"+i.id),n=InputFactory.getInstance(r,{input:r,baseName:i.templateInputName,index:e,reference:i.id});if(t[i.attribute])if(Array.isArray(t[i.attribute]))t[i.attribute].push(await n.getValue());else{const e=t[i.attribute];t[i.attribute]=[e,await n.getValue()]}else t[i.attribute]=await n.getValue()}return t}get tableId(){return this.config.options.id}get table(){return $(`#${this.tableId}`)}get tableBody(){return $(`#${this.tableId}`).find("tbody")}get rowOptions(){const t=this.config.rowOptions;return Object.keys(t).reduce(((e,i)=>e+`${i}="${t[i]}" `),"").trim()}get deleteRowClass(){return this.config.deleteRowClass}get widgetContainer(){return this.config.widgetContainer}get selectorTableRows(){return`#${this.widgetContainer} tbody tr`}reorderInputs(){$(this.selectorTableRows).each(((t,e)=>{$(e).find('input[type="hidden"]').each(((e,i)=>{$(i).attr("name",$(i).attr("name").replace(/\[\d+\]/,`[${t}]`))}))})),this.index=this.currentTotalRows}get currentTotalRows(){return $(this.selectorTableRows).length}isEditMode(){return!!this.tableBody.find('tr[data-edit="true"]').length}get rowEdit(){return this.tableBody.find('tr[data-edit="true"]')}async getHtmlRow(){let t="";const e=await this.getValueColumns();for(const i of this.columns){const r=$("#"+i.id);t+=await i.classJs.renderContent(e,this.index),i.cleanAfterInsert&&r.val("").trigger("change")}return t=this.getTrHtml(t),t=$(t),t}async triggerBeforeUpdate(){$("#"+this.config.widgetContainer).triggerHandler("beforeUpdate",await this.getValueColumns())}triggerAfterUpdate(t){$("#"+this.config.widgetContainer).triggerHandler("afterUpdate",t)}cancelEdit(){this.rowEdit.removeAttr("data-edit")}async getAllDataTable(){const t=[];return $(this.selectorTableRows).each((async(e,i)=>{let r={};for(const[t,e]of this.columns.entries())if(e.id){const t=$(i).find(`input[data-reference="${e.id}"]`),n=InputFactory.getInstance(t);r[e.id]=await n.getValue()}t.push(r)})),t}async triggerBeforeDelete(t){return $("#"+this.config.widgetContainer).triggerHandler("beforeDelete",[t,this])}triggerAfterDelete(t){$("#"+this.config.widgetContainer).triggerHandler("afterDelete",[t,this])}}